<!DOCTYPE html>
<html lang="en">
<head>
    <title>Image Rendering with WebGL Shader</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        #canvas {
            width: 640px;
            height: 360px;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="640" height="360"></canvas>
<video autoplay id="selfVideo"></video>
<!-- // debug purpose -->
<canvas id="c" width="640" height="360"></canvas>
<script type="module">
    import { getRawFrames } from './get-raw-frames.mjs';
    import { initWebGl } from './setup-webgl.mjs';
    import { setupDebug } from './debug.mjs';

    const [vs, fs] = await Promise.all([
        await fetch('vertex.glsl').then(r => r.text()),
        fetch('yuv-nv12-cas.glsl').then(r => r.text()),
    ]);

    /**
     * @param {CanvasRenderingContext2D} ctx
     * @param {object} target
     * @returns {(function(*): void)} function to check if "target.catchFrame" was called and if so, store provided frame data
     */
    const canvas = document.getElementById('canvas');
    const gl = canvas.getContext('webgl2', { alpha: true, antialias: false, colorSpace: "srgb" });

    if (!gl) throw new Error('WebGL2 is not supported');

    const drawGl = initWebGl(gl, vs, fs);

    // debug
    const ctx = document.getElementById('c').getContext('2d');
    const debugHook = setupDebug(ctx, window);

    // camera load
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 360 } });
    document.getElementById('selfVideo').srcObject = stream;

    let bufferSize = 0, format = '', view_y, view_uv;
    for await (const frameData of getRawFrames(stream)) {
        if (bufferSize !== frameData.buffer.byteLength || format !== frameData.format) {
            bufferSize = frameData.buffer.byteLength;
            format = frameData.format;
            if (frameData.format !== 'NV12') {
                alert(`Only NV12 frames are supported but got ${format}!`);
                throw new Error('Invalid frame format');
            }
            view_y = new Uint8Array(frameData.buffer.buffer, 0, frameData.planes[1].offset);
            view_uv = new Uint8Array(frameData.buffer.buffer, frameData.planes[1].offset);
        }

        drawGl(frameData.visibleRect.width, frameData.visibleRect.height, view_y, view_uv);

        // debug
        debugHook(frameData);
    }
</script>
</body>
</html>
